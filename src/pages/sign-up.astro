---
export const prerender = false;

import { getAnonymousIdFromCookie } from '../utils/auth';

// Check if user has a guest session to preserve
const cookieHeader = Astro.request.headers.get('cookie');
const hasGuestSession = !!getAnonymousIdFromCookie(cookieHeader);
---

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign Up - ARA System</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
</head>
<body>
  <div class="min-h-screen bg-base-100 flex items-center justify-center">
    <div class="card w-96 bg-base-200 shadow-xl">
      <div class="card-body">
        <h2 class="card-title justify-center mb-6">Create ARA Account</h2>
        
        {hasGuestSession && (
          <div class="alert alert-info mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <h3 class="font-bold">Save Your Progress!</h3>
              <div class="text-xs">Your audit progress will be preserved when you create an account.</div>
            </div>
          </div>
        )}
        
        <div id="clerk-sign-up"></div>
        
        <div class="divider">Benefits of creating an account</div>
        <ul class="text-sm text-base-content/70 space-y-1">
          <li>✅ Save progress across devices</li>
          <li>✅ Access detailed analytics</li>
          <li>✅ Download PDF reports</li>
          <li>✅ Track progress over time</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    import { ClerkJS } from '@clerk/clerk-js';
    
    const publishableKey = import.meta.env.PUBLIC_CLERK_PUBLISHABLE_KEY;
    
    if (!publishableKey) {
      throw new Error('Missing Clerk Publishable Key');
    }
    
    // Wrap in async function to avoid top-level await
    (async () => {
      const clerk = new ClerkJS(publishableKey);
      await clerk.load();
    
    const signUpDiv = document.getElementById('clerk-sign-up');
    if (signUpDiv) {
      clerk.mountSignUp(signUpDiv, {
        signInUrl: '/sign-in',
        afterSignUpUrl: '/dashboard',
      });
    }

      // Handle guest session conversion after successful sign up
      clerk.addListener('user.signed_up', async (user) => {
        try {
          // Convert guest session if it exists
          const response = await fetch('/api/guest/convert-session', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ userId: user.id }),
          });

          if (response.ok) {
            const data = await response.json();
            console.log('✅ Guest session converted successfully:', data);
            
            // Show success message briefly before redirect
            const toast = document.createElement('div');
            toast.className = 'toast toast-top toast-end';
            toast.innerHTML = `
              <div class="alert alert-success">
                <span>✅ Progress saved! Redirecting to dashboard...</span>
              </div>
            `;
            document.body.appendChild(toast);
            
            // Redirect after short delay
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 1500);
          } else {
            // If conversion fails, still proceed to dashboard
            console.warn('Guest session conversion failed, proceeding to dashboard');
            window.location.href = '/dashboard';
          }
        } catch (error) {
          console.error('Error converting guest session:', error);
          // Still proceed to dashboard even if conversion fails
          window.location.href = '/dashboard';
        }
      });
    })();
  </script>
</body>
</html>